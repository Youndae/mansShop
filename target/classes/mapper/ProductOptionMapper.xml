<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.shop.mapper.ProductOptionMapper">

    <select id="findAllDetailByProductId" resultType="ProductOptionDTO">
        SELECT id as optionId
            , productSize as pSize
            , productColor as color
            , stock
            , isOpen
        FROM productOption
        where PRODUCTID = #{productId}
    </select>

    <update id="patchProductOptionToOrder" parameterType="java.util.List">
        <foreach collection="list" item="option" index="idx" separator=";" open="DECLARE BEGIN" close="; END;">
            UPDATE productOption
            SET
            stock = stock - #{option.count}
            WHERE id = #{option.id}
        </foreach>
    </update>

    <insert id="saveOptions" parameterType="map">
        {CALL insert_product_options(
            #{options, jdbcType=ARRAY, jdbcTypeName="PRODUCT_OPTION_OBJ_LIST"
                , typeHandler=org.shop.mapper.typeHandler.ProductOptionTypeHandler}
        )}
    </insert>

    <update id="patchOptions" parameterType="java.util.List">
        <foreach collection="list" item="option" index="idx" separator=";" open="DECLARE BEGIN" close="; END;">
            UPDATE productOption
            SET productSize = #{option.productSize}
                , productColor = #{option.productColor}
                , stock = #{option.stock}
                , isOpen = #{option.isOpen}
            WHERE id = #{option.id}
        </foreach>
    </update>

    <delete id="deleteByIds" parameterType="Long">
        DELETE FROM productOption
        <where>
            <foreach collection="list" item="item" open="" close="" separator="OR">
                (id = #{item})
            </foreach>
        </where>
    </delete>

    <select id="findAllByProductId" resultType="ProductOption">
        SELECT *
        FROM productOption
        WHERE productId IN
              <foreach collection="list" item="item" open="(" separator="," close=")">
                  #{item}
              </foreach>
    </select>

    <select id="findAllOptionByProductId" resultType="ProductOption">
        SELECT *
        FROM productOption
        WHERE productId = #{id}
        ORDER BY id
    </select>
</mapper>